name: 3. Deploy DDL
on: workflow_dispatch

jobs:
  deploy-ddl:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install Schemachange
        run: pip install schemachange snowflake-connector-python

      # --------------------------------------------------------
      # âœ… NEW STEP: CREATE DB & SCHEMA IF MISSING
      # --------------------------------------------------------
      - name: Bootstrap Target Database
        env:
          SNOWFLAKE_USER: ${{ vars.TARGET_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.TARGET_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ vars.TARGET_ACCOUNT }}
          SNOWFLAKE_ROLE: ${{ vars.TARGET_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ vars.TARGET_WAREHOUSE }}
          # These pull the names 'DQ_FRAMEWORK_TEST' and 'METADATA_TEST'
          TARGET_DB: ${{ vars.TARGET_DATABASE }}
          TARGET_SCHEMA: ${{ vars.TARGET_SCHEMA }}
        run: |
          python -c "
          import snowflake.connector
          import os
          
          print('ðŸ”Œ Connecting to Snowflake to bootstrap environment...')
          conn = snowflake.connector.connect(
              user=os.environ['SNOWFLAKE_USER'],
              password=os.environ['SNOWFLAKE_PASSWORD'],
              account=os.environ['SNOWFLAKE_ACCOUNT'],
              role=os.environ['SNOWFLAKE_ROLE'],
              warehouse=os.environ['SNOWFLAKE_WAREHOUSE']
          )
          
          db = os.environ['TARGET_DB']
          schema = os.environ['TARGET_SCHEMA']
          
          print(f'ðŸ”¨ Ensuring Database exists: {db}')
          conn.cursor().execute(f'CREATE DATABASE IF NOT EXISTS {db}')
          
          print(f'ðŸ”¨ Ensuring Schema exists: {db}.{schema}')
          conn.cursor().execute(f'CREATE SCHEMA IF NOT EXISTS {db}.{schema}')
          
          print('âœ… Bootstrap complete.')
          conn.close()
          "

      # --------------------------------------------------------
      # EXISTING STEP: RUN SCHEMACHANGE
      # --------------------------------------------------------
      - name: Deploy to Target
        env:
          SNOWFLAKE_PASSWORD: ${{ secrets.TARGET_PASSWORD }}
          SNOWFLAKE_ACCOUNT: ${{ vars.TARGET_ACCOUNT }}
          SNOWFLAKE_USER: ${{ vars.TARGET_USER }}
          SNOWFLAKE_ROLE: ${{ vars.TARGET_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ vars.TARGET_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ vars.TARGET_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ vars.TARGET_SCHEMA }}
        run: |
          schemachange -f scripts/ddl \
            -a $SNOWFLAKE_ACCOUNT \
            -u $SNOWFLAKE_USER \
            -r $SNOWFLAKE_ROLE \
            -w $SNOWFLAKE_WAREHOUSE \
            -d $SNOWFLAKE_DATABASE \
            -c $SNOWFLAKE_DATABASE.$SNOWFLAKE_SCHEMA.CHANGE_HISTORY \
            --create-change-history-table \
            --vars "{\"snowflake_database\": \"$SNOWFLAKE_DATABASE\", \"snowflake_schema\": \"$SNOWFLAKE_SCHEMA\"}"